name: Deploy Staging

on:
  push:
    branches: [staging]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: dbca-wa/science-projects

permissions:
  contents: read
  packages: write

jobs:
  # ====================== RUN TESTS ======================
  run-tests:
    name: Run Tests
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    uses: ./.github/workflows/test.yml

  # ====================== DETECT CHANGES ======================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    needs: run-tests
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - '.github/workflows/deploy-staging.yml'
            backend:
              - 'backend/**'
              - '.github/workflows/deploy-staging.yml'

  # ====================== BUILD FRONTEND TEST ======================
  build-frontend-test:
    name: Build Frontend (Test)
    runs-on: ubuntu-latest
    needs: [run-tests, detect-changes]
    if: |
      !contains(github.event.head_commit.message, '[skip ci]') &&
      success() &&
      needs.detect-changes.outputs.frontend == 'true'

    env:
      VITE_PRODUCTION_BASE_URL: "https://scienceprojects-test.dbca.wa.gov.au/"
      VITE_PRODUCTION_BACKEND_API_URL: "https://scienceprojects-test.dbca.wa.gov.au/api/v1/"
      VITE_PRODUCTION_PROFILES_BASE_URL: "https://science-profiles-test.dbca.wa.gov.au/"
      VITE_SENTRY_ENVIRONMENT: "test"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log into registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract commit SHA
        id: sha
        run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Build and push Frontend Test image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:test
          build-args: |
            VITE_PRODUCTION_BACKEND_API_URL=${{ env.VITE_PRODUCTION_BACKEND_API_URL }}
            VITE_VERSION=test-${{ github.sha }}
            VITE_SENTRY_ENVIRONMENT=test
            VITE_SENTRY_DSN=https://8dd0517876955893e7c6c13dda43ae8b@o4506736817405952.ingest.us.sentry.io/4507297807663104
          cache-from: type=gha,scope=frontend-staging
          cache-to: type=gha,mode=max,scope=frontend-staging
          labels: |
            org.opencontainers.image.title=Science Projects Frontend (Test)
            org.opencontainers.image.version=test-${{ steps.sha.outputs.SHORT_SHA }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

  # ====================== BUILD BACKEND TEST ======================
  build-backend-test:
    name: Build Backend (Test)
    runs-on: ubuntu-latest
    needs: [run-tests, detect-changes]
    if: |
      !contains(github.event.head_commit.message, '[skip ci]') &&
      success() &&
      needs.detect-changes.outputs.backend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log into registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract commit SHA
        id: sha
        run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Build and push Backend Test image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:test
          cache-from: type=gha,scope=backend-staging
          cache-to: type=gha,mode=max,scope=backend-staging
          labels: |
            org.opencontainers.image.title=Science Projects Backend (Test)
            org.opencontainers.image.version=test-${{ steps.sha.outputs.SHORT_SHA }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
