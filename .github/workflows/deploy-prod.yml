name: Deploy Production

on:
  push:
    tags:
      - "v*"
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: dbca-wa/science-projects

permissions:
  contents: write
  packages: write

jobs:
  # ====================== DETECT CHANGES ======================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.override.outputs.frontend }}
      backend: ${{ steps.override.outputs.backend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # For tagged releases, always build both frontend and backend
      - name: Set build flags for release
        id: override
        run: |
          echo "frontend=true" >> $GITHUB_OUTPUT
          echo "backend=true" >> $GITHUB_OUTPUT
          echo "✅ Tagged release detected - building both frontend and backend"

  # ====================== RUN TESTS ======================
  run-tests:
    name: Run Tests
    needs: detect-changes
    uses: ./.github/workflows/test.yml

  # ====================== BUILD FRONTEND PRODUCTION ======================
  build-frontend-prod:
    name: Build Frontend (Production)
    runs-on: ubuntu-latest
    needs: [run-tests, detect-changes]
    if: |
      success() &&
      needs.detect-changes.outputs.frontend == 'true'
    
    env:
      VITE_PRODUCTION_BASE_URL: "https://scienceprojects.dbca.wa.gov.au/"
      VITE_PRODUCTION_BACKEND_API_URL: "https://scienceprojects.dbca.wa.gov.au/api/v1/"
      VITE_PRODUCTION_PROFILES_BASE_URL: "https://science-profiles.dbca.wa.gov.au/"
      VITE_SENTRY_ENVIRONMENT: "production"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log into registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION}"

      - name: Build and push Frontend Production image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:${{ steps.version.outputs.VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:stable
          build-args: |
            VITE_PRODUCTION_BACKEND_API_URL=${{ env.VITE_PRODUCTION_BACKEND_API_URL }}
            VITE_VERSION=${{ steps.version.outputs.VERSION }}
            VITE_SENTRY_ENVIRONMENT=production
            VITE_SENTRY_DSN=https://8dd0517876955893e7c6c13dda43ae8b@o4506736817405952.ingest.us.sentry.io/4507297807663104
          cache-from: type=gha,scope=frontend-prod
          cache-to: type=gha,mode=max,scope=frontend-prod
          labels: |
            org.opencontainers.image.title=Science Projects Frontend (Production)
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

  # ====================== BUILD BACKEND PRODUCTION ======================
  build-backend-prod:
    name: Build Backend (Production)
    runs-on: ubuntu-latest
    needs: [run-tests, detect-changes]
    if: |
      success() &&
      needs.detect-changes.outputs.backend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log into registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION}"

      - name: Build and push Backend Production image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:${{ steps.version.outputs.VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:stable
          cache-from: type=gha,scope=backend-prod
          cache-to: type=gha,mode=max,scope=backend-prod
          labels: |
            org.opencontainers.image.title=Science Projects Backend (Production)
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

  # ====================== UPDATE COVERAGE BADGES ======================
  update-coverage-badges:
    name: Update Coverage Badges
    needs: run-tests
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git with bot credentials
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download coverage percentages
        uses: actions/download-artifact@v4
        with:
          pattern: '*-coverage-percentage'
          path: coverage-percentages

      - name: Update frontend badge in README
        run: |
          if [ -f "coverage-percentages/frontend-coverage-percentage/coverage-percentage.txt" ]; then
            # Read and validate coverage value
            COVERAGE_RAW=$(cat coverage-percentages/frontend-coverage-percentage/coverage-percentage.txt)
            
            # Validate it's a number
            if ! [[ "$COVERAGE_RAW" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
              echo "⚠️  Warning: Invalid frontend coverage format: $COVERAGE_RAW"
              echo "Skipping frontend badge update"
            else
              # Extract integer part
              COVERAGE=$(echo "$COVERAGE_RAW" | cut -d'.' -f1)
              
              # Determine color
              COLOR="red"
              if [ "$COVERAGE" -ge 80 ]; then COLOR="brightgreen"
              elif [ "$COVERAGE" -ge 70 ]; then COLOR="green"
              elif [ "$COVERAGE" -ge 60 ]; then COLOR="yellow"
              elif [ "$COVERAGE" -ge 50 ]; then COLOR="orange"
              fi
              
              # Update badge
              sed -i "s|frontend--coverage-[0-9]*%25-[a-z]*|frontend--coverage-${COVERAGE}%25-${COLOR}|g" README.md
              echo "✅ Updated frontend badge: ${COVERAGE}% (${COLOR})"
            fi
          else
            echo "⚠️  Warning: Frontend coverage file not found"
          fi

      - name: Update backend badge in README
        run: |
          if [ -f "coverage-percentages/backend-coverage-percentage/coverage-percentage.txt" ]; then
            # Read and validate coverage value
            COVERAGE_RAW=$(cat coverage-percentages/backend-coverage-percentage/coverage-percentage.txt)
            
            # Validate it's a number
            if ! [[ "$COVERAGE_RAW" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
              echo "⚠️  Warning: Invalid backend coverage format: $COVERAGE_RAW"
              echo "Skipping backend badge update"
            else
              # Extract integer part
              COVERAGE=$(echo "$COVERAGE_RAW" | cut -d'.' -f1)
              
              # Determine color
              COLOR="red"
              if [ "$COVERAGE" -ge 80 ]; then COLOR="brightgreen"
              elif [ "$COVERAGE" -ge 70 ]; then COLOR="green"
              elif [ "$COVERAGE" -ge 60 ]; then COLOR="yellow"
              elif [ "$COVERAGE" -ge 50 ]; then COLOR="orange"
              fi
              
              # Update badge
              sed -i "s|backend--coverage-[0-9]*%25-[a-z]*|backend--coverage-${COVERAGE}%25-${COLOR}|g" README.md
              echo "✅ Updated backend badge: ${COVERAGE}% (${COLOR})"
            fi
          else
            echo "⚠️  Warning: Backend coverage file not found"
          fi

      - name: Commit and push badge updates
        run: |
          git add README.md
          git commit -m "chore: update coverage badges [skip ci]" || exit 0
          git push

  # ====================== UPDATE KUSTOMIZE ======================
  update-kustomize:
    name: Update Kustomize Configurations
    needs: [detect-changes, build-frontend-prod, build-backend-prod]
    runs-on: ubuntu-latest
    if: |
      always() && 
      (needs.build-frontend-prod.result == 'success' || needs.build-backend-prod.result == 'success')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION}"

      - name: Update kustomize image tags
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          echo "=== Updating Kustomize image tags to ${VERSION} ==="

          # Update production kustomization.yaml (both frontend and backend)
          if [ -f "kustomize/overlays/prod/kustomization.yaml" ]; then
            sed -i "s|newTag: .*|newTag: ${VERSION}|g" kustomize/overlays/prod/kustomization.yaml
            echo "✅ Updated production kustomization.yaml"
            echo ""
            echo "=== Changes to production ==="
            git diff kustomize/overlays/prod/kustomization.yaml
          else
            echo "❌ Warning: kustomize/overlays/prod/kustomization.yaml not found"
            exit 1
          fi

          # Update test kustomization.yaml (both frontend and backend)
          if [ -f "kustomize/overlays/test/kustomization.yaml" ]; then
            sed -i "s|newTag: .*|newTag: ${VERSION}|g" kustomize/overlays/test/kustomization.yaml
            echo "✅ Updated test kustomization.yaml"
            echo ""
            echo "=== Changes to test ==="
            git diff kustomize/overlays/test/kustomization.yaml
          else
            echo "❌ Warning: kustomize/overlays/test/kustomization.yaml not found"
            exit 1
          fi

      - name: Commit and push kustomize updates
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          # Check if there are changes to commit
          if git diff --quiet kustomize/; then
            echo "✅ No changes to commit (versions already up to date)"
          else
            # Commit and push
            git add kustomize/overlays/prod/kustomization.yaml
            git add kustomize/overlays/test/kustomization.yaml
            git commit -m "chore: update kustomize to ${VERSION} [skip ci]"
            git push origin HEAD:main
            echo "✅ Kustomize versions updated to ${VERSION}"
          fi

      - name: Deployment summary
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          echo "## Deployment Configuration Updated" >> $GITHUB_STEP_SUMMARY
          echo "✅ Kustomize overlays updated to version ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Updated Images" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ghcr.io/dbca-wa/science-projects-frontend:${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ghcr.io/dbca-wa/science-projects-backend:${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Test environment will use new images" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify functionality in test environment" >> $GITHUB_STEP_SUMMARY
          echo "3. Deploy to production when ready" >> $GITHUB_STEP_SUMMARY
