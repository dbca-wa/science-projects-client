name: Deploy Production

on:
  push:
    tags:
      - "v*"

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: dbca-wa/science-projects

permissions:
  contents: write
  packages: write

jobs:
  # ====================== DETECT CHANGES ======================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.override.outputs.frontend }}
      backend: ${{ steps.override.outputs.backend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # For tagged releases, always build both frontend and backend
      - name: Set build flags for release
        id: override
        run: |
          echo "frontend=true" >> $GITHUB_OUTPUT
          echo "backend=true" >> $GITHUB_OUTPUT
          echo "✅ Tagged release detected - building both frontend and backend"

  # ====================== BUILD FRONTEND PRODUCTION ======================
  build-frontend-prod:
    name: Build Frontend (Production)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    
    env:
      VITE_PRODUCTION_BASE_URL: "https://scienceprojects.dbca.wa.gov.au/"
      VITE_PRODUCTION_BACKEND_API_URL: "https://scienceprojects.dbca.wa.gov.au/api/v1/"
      VITE_PRODUCTION_PROFILES_BASE_URL: "https://science-profiles.dbca.wa.gov.au/"
      VITE_SENTRY_ENVIRONMENT: "production"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log into registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build and push Frontend Production image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:${{ steps.version.outputs.VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:stable
          build-args: |
            VITE_PRODUCTION_BACKEND_API_URL=${{ env.VITE_PRODUCTION_BACKEND_API_URL }}
            VITE_VERSION=${{ steps.version.outputs.VERSION }}
            VITE_SENTRY_ENVIRONMENT=production
            VITE_SENTRY_DSN=https://8dd0517876955893e7c6c13dda43ae8b@o4506736817405952.ingest.us.sentry.io/4507297807663104
          cache-from: type=gha,scope=frontend-prod
          cache-to: type=gha,mode=max,scope=frontend-prod
          labels: |
            org.opencontainers.image.title=Science Projects Frontend (Production)
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

  # ====================== BUILD BACKEND ======================
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log into registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build and push Backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:${{ steps.version.outputs.VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:stable
          cache-from: type=gha,scope=backend-prod
          cache-to: type=gha,mode=max,scope=backend-prod
          labels: |
            org.opencontainers.image.title=Science Projects Backend (Production)
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

  # ====================== UPDATE KUSTOMIZE ======================
  update-kustomize:
    name: Update Kustomize Configurations
    needs: [detect-changes, build-frontend-prod, build-backend]
    runs-on: ubuntu-latest
    if: |
      always() && 
      (needs.build-frontend-prod.result == 'success' || needs.build-backend.result == 'success')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Update kustomize image tags
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          echo "=== Updating Kustomize image tags to ${VERSION} ==="

          # Update production kustomization.yaml (both frontend and backend)
          if [ -f "kustomize/overlays/prod/kustomization.yaml" ]; then
            sed -i "s|newTag: .*|newTag: ${VERSION}|g" kustomize/overlays/prod/kustomization.yaml
            echo "✅ Updated production kustomization.yaml"
            echo ""
            echo "=== Changes to production ==="
            git diff kustomize/overlays/prod/kustomization.yaml
          else
            echo "❌ Warning: kustomize/overlays/prod/kustomization.yaml not found"
            exit 1
          fi

          # Update test kustomization.yaml (both frontend and backend)
          if [ -f "kustomize/overlays/test/kustomization.yaml" ]; then
            sed -i "s|newTag: .*|newTag: ${VERSION}|g" kustomize/overlays/test/kustomization.yaml
            echo "✅ Updated test kustomization.yaml"
            echo ""
            echo "=== Changes to test ==="
            git diff kustomize/overlays/test/kustomization.yaml
          else
            echo "❌ Warning: kustomize/overlays/test/kustomization.yaml not found"
            exit 1
          fi

      - name: Commit and push kustomize updates
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          # Check if there are changes to commit
          if git diff --quiet kustomize/; then
            echo "✅ No changes to commit (versions already up to date)"
          else
            # Commit and push
            git add kustomize/overlays/prod/kustomization.yaml
            git add kustomize/overlays/test/kustomization.yaml
            git commit -m "chore: update kustomize to ${VERSION} [skip ci]"
            git push origin HEAD:main
            echo "✅ Kustomize versions updated to ${VERSION}"
          fi

      - name: Deployment summary
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          echo "## Deployment Configuration Updated" >> $GITHUB_STEP_SUMMARY
          echo "✅ Kustomize overlays updated to version ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Updated Images" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ghcr.io/dbca-wa/science-projects-frontend:${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ghcr.io/dbca-wa/science-projects-backend:${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Test environment will use new images" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify functionality in test environment" >> $GITHUB_STEP_SUMMARY
          echo "3. Deploy to production when ready" >> $GITHUB_STEP_SUMMARY


